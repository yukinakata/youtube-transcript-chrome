# architecture.md - システムアーキテクチャ

## 概要

本システムは、macOS上でリアルタイム音声文字起こしを行うローカルアプリケーションである。

## システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                         macOS                                   │
│                                                                 │
│  ┌──────────────┐      ┌─────────────────────────────────────┐ │
│  │  音声ソース   │      │        BlackHole 2ch               │ │
│  │  (YouTube等) │ ───→ │    (仮想オーディオデバイス)         │ │
│  └──────────────┘      └─────────────────────────────────────┘ │
│         │                              │                        │
│         ↓                              ↓                        │
│  ┌──────────────┐      ┌─────────────────────────────────────┐ │
│  │   スピーカー  │      │     sounddevice (音声キャプチャ)    │ │
│  │   (聴取用)   │      │         ↓                          │ │
│  └──────────────┘      │     AudioBuffer (3秒バッファ)      │ │
│                        │         ↓                          │ │
│                        │     faster-whisper                 │ │
│                        │     (Apple Silicon最適化)          │ │
│                        │         ↓                          │ │
│                        │     ┌─────────┬─────────┐          │ │
│                        │     ↓         ↓         ↓          │ │
│                        │  Terminal   LogFile   (Future)     │ │
│                        │   出力       保存       GUI        │ │
│                        └─────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. AudioCapture（音声キャプチャ）

```python
# audio_capture.py
class AudioCapture:
    """
    責務: BlackHoleから音声ストリームを取得
    
    - サンプルレート: 16000Hz（Whisper推奨）
    - チャンネル: モノラル
    - バッファサイズ: 3秒分
    """
```

**依存関係:**
- `sounddevice`: 音声入力
- `numpy`: 音声データ処理

### 2. Transcriber（文字起こし）

```python
# transcriber.py
class Transcriber:
    """
    責務: 音声データをテキストに変換
    
    - モデル: faster-whisper small
    - 言語: 日本語/英語/自動検出
    - 処理: ストリーミング対応
    """
```

**依存関係:**
- `faster-whisper`: Whisperの高速実装
- `ctranslate2`: Apple Silicon最適化推論

### 3. Logger（ログ管理）

```python
# logger.py
class TranscriptLogger:
    """
    責務: ターミナル出力とファイル保存
    
    - 出力形式: [HH:MM:SS] テキスト
    - 保存先: ./logs/YYYY-MM-DD_HH-MM-SS.txt
    - エンコーディング: UTF-8
    """
```

## データフロー

```
音声入力 (16kHz, mono)
    │
    ▼
┌─────────────────┐
│  Ring Buffer    │  ← 3秒分の音声を保持
│  (48000 samples)│
└─────────────────┘
    │
    ▼ (3秒ごとにトリガー)
┌─────────────────┐
│  Whisper処理    │  ← GPU/CPU で推論
│  (非同期)       │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│  テキスト出力   │
│  - Terminal     │
│  - LogFile      │
└─────────────────┘
```

## 設定パラメータ

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| SAMPLE_RATE | 16000 | サンプリングレート |
| CHUNK_DURATION | 3.0 | バッファ秒数 |
| MODEL_SIZE | "small" | Whisperモデル |
| LANGUAGE | "ja" | 認識言語 |
| LOG_DIR | "./logs" | ログ保存先 |

## エラーハンドリング

```
┌─────────────────────────────────────────────┐
│  起動時チェック                             │
│  1. BlackHoleデバイスの存在確認             │
│  2. Whisperモデルの存在確認（なければDL）   │
│  3. ログディレクトリの作成                  │
└─────────────────────────────────────────────┘
          │
          ▼ 失敗時
┌─────────────────────────────────────────────┐
│  エラーメッセージ + セットアップガイド表示   │
└─────────────────────────────────────────────┘
```

## 将来の拡張ポイント

1. **GUI対応**: PyQt6によるウィンドウアプリ化
2. **オーバーレイ表示**: 半透明字幕ウィンドウ
3. **複数言語同時対応**: 言語自動切替
4. **要約機能**: Claude API連携
5. **動画ファイル対応**: ffmpegによる音声抽出
